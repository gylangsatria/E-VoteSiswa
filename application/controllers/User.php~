<?php 
class User extends CI_Controller {
    public function __construct() {
        parent::__construct();
        $this->load->database();
        $this->load->helper(['form', 'url']);
        $this->load->library(['session']);
        $this->load->model(['User_Model']);
    }

    public function login() {
        if ($this->session->userdata('username')) {
            redirect('user/index');
        }
        $this->load->view('user/head');
        $this->load->view('user/login');
        $this->load->view('user/footer');
    }

    public function loginvalidation() {
        $username = $this->input->post('username', TRUE);
        $password = $this->input->post('password', TRUE);
        $result   = $this->User_Model->login($username, $password);
        $valid    = $this->User_Model->valid($username); // cek apakah sudah voting

        if ($valid === true) {
            $this->session->set_flashdata('block', 'Anda sudah pernah melakukan voting. Akun Anda dinonaktifkan. Jika ini kesalahan, hubungi panitia.');
            redirect('user/login');
        } else {
            if ($result === true) {
                $this->session->set_userdata(['username' => $username]);
                redirect('user/index');
            } else {
                $this->session->set_flashdata('failed', 'Username atau Password salah');
                redirect('user/login');
            }
        }
    }

    public function logout() {
        $this->session->unset_userdata('username');
        redirect('user/login');
    }

    public function index() {
        if (! $this->session->userdata('username')) {
            redirect('user/login');
        }

        // Cegah cache agar tombol back tidak bisa akses ulang halaman voting
        $this->output->set_header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
        $this->output->set_header("Cache-Control: post-check=0, pre-check=0", false);
        $this->output->set_header("Pragma: no-cache");

        $username = $this->session->userdata('username');
        $data['username'] = $username;
        $data['datacalon'] = $this->User_Model->datamodel();
        $data['sudah_memilih'] = $this->User_Model->cek_status_vote($username); // true/false

        $this->load->view('user/head');
        $this->load->view('user/navbar');
        $this->load->view('user/index', $data);
        $this->load->view('user/footer');
    }

    public function vote() {
        if (! $this->session->userdata('username')) {
            redirect('user/login');
        }

        $nisn     = $this->input->post('nisn');
        $username = $this->input->post('username');

        // Cegah vote ulang
        if ($this->User_Model->cek_status_vote($username)) {
            $this->session->set_flashdata('block', 'Anda sudah memilih. Tidak dapat memilih lagi.');
            redirect('user/index');
        }

        $vote  = $this->User_Model->vote($nisn, $username);
        $hadir = $this->User_Model->hadir($username);

        if ($vote === true) {
            redirect('user/viewlogout');
        } else {
            $this->session->set_flashdata('failed', 'Gagal menyimpan suara. Silakan coba lagi.');
            redirect('user/index');
        }
    }

    public function viewlogout() {
        $this->load->view('user/head');
        $this->load->view('user/navbar');
        $this->load->view('user/viewlogout');
        $this->load->view('user/footer');
    }
}
?>

